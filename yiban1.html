<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¹³æ»‘MPCæ§åˆ¶ - æ–‡åŒ–é—äº§æœºå™¨äºº</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft YaHei', sans-serif; 
            background: #1a1a2e;
            color: white;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }
        
        #scene-container {
            flex: 3;
            position: relative;
            background: #0f3460;
        }
        
        #control-panel {
            flex: 1;
            background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
            padding: 20px;
            max-width: 450px;
            border-left: 4px solid #00b4d8;
        }
        
        .smooth-control {
            background: rgba(0, 180, 216, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid rgba(0, 180, 216, 0.3);
        }
        
        .control-btn {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            background: #0077b6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: #0096c7;
            transform: translateY(-2px);
        }
        
        .smoothness-indicator {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
            position: relative;
        }
        
        .smoothness-fill {
            height: 100%;
            background: linear-gradient(90deg, #e63946, #f4a261, #2a9d8f);
            width: 0%;
            transition: width 0.5s;
            border-radius: 10px;
        }
        
        .physics-params {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        .param-item {
            background: rgba(42, 157, 143, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .param-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2a9d8f;
        }
        
        .log-entry {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            font-size: 12px;
            border-left: 3px solid #00b4d8;
        }
    </style>
    <script src="https://unpkg.com/three@0.132.2/build/three.min.js"></script>
</head>
<body>
    <div id="scene-container"></div>
    
    <div id="control-panel">
        <h2 style="color: #00b4d8;">ğŸ¤– å¹³æ»‘MPCæ§åˆ¶ç³»ç»Ÿ</h2>
        
        <div class="smooth-control">
            <h3>ğŸ¯ å¹³æ»‘åº¦æ§åˆ¶</h3>
            <div>è¿åŠ¨å¹³æ»‘åº¦: <span id="smoothnessValue">75%</span></div>
            <div class="smoothness-indicator">
                <div class="smoothness-fill" id="smoothnessFill"></div>
            </div>
            
            <div class="physics-params">
                <div class="param-item">
                    <div>æœ€å¤§é€Ÿåº¦</div>
                    <div class="param-value" id="maxSpeed">2.0 m/s</div>
                </div>
                <div class="param-item">
                    <div>æœ€å¤§åŠ é€Ÿåº¦</div>
                    <div class="param-value" id="maxAccel">1.0 m/sÂ²</div>
                </div>
                <div class="param-item">
                    <div>é˜»å°¼ç³»æ•°</div>
                    <div class="param-value" id="damping">0.8</div>
                </div>
                <div class="param-item">
                    <div>è¿åŠ¨è¯¯å·®</div>
                    <div class="param-value" id="positionError">0.0 m</div>
                </div>
            </div>
        </div>
        
        <div class="smooth-control">
            <h3>ğŸš€ å¹³æ»‘æ¼”ç¤º</h3>
            <button class="control-btn" onclick="runSmoothDemo('straight')">
                ç›´çº¿å¹³æ»‘è¿åŠ¨
            </button>
            <button class="control-btn" onclick="runSmoothDemo('curve')">
                æ›²çº¿å¹³æ»‘è¿åŠ¨
            </button>
            <button class="control-btn" onclick="runSmoothDemo('pickup')">
                å¹³æ»‘æŠ“å–æ¼”ç¤º
            </button>
            <button class="control-btn" onclick="toggleOscillation()" style="background: #e63946;">
                <span id="oscillationToggle">ğŸ”´ å…³é—­éœ‡è¡</span>
            </button>
        </div>
        
        <div class="smooth-control">
            <h3>ğŸ“Š è¿åŠ¨åˆ†æ</h3>
            <div id="motionLog" style="height: 200px; overflow-y: auto;">
                <!-- è¿åŠ¨æ—¥å¿— -->
            </div>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
            <h4>ğŸ¯ å¹³æ»‘æ§åˆ¶åŸç†</h4>
            <p>1. <strong>é€Ÿåº¦é™åˆ¶</strong>ï¼šé™åˆ¶æœ€å¤§è¿åŠ¨é€Ÿåº¦</p>
            <p>2. <strong>åŠ é€Ÿåº¦é™åˆ¶</strong>ï¼šå¹³æ»‘å¯åœï¼Œé¿å…æ€¥åŠ¨</p>
            <p>3. <strong>é˜»å°¼ç³»ç»Ÿ</strong>ï¼šå¸æ”¶å¤šä½™èƒ½é‡ï¼Œé˜²æ­¢æŒ¯è¡</p>
            <p>4. <strong>é¢„æµ‹ä¿®æ­£</strong>ï¼šæå‰å‡é€Ÿï¼Œç²¾ç¡®åˆ°ä½</p>
        </div>
    </div>

    <script>
        // ==================== å¹³æ»‘MPCæ§åˆ¶ç³»ç»Ÿ ====================
        console.log("å¯åŠ¨å¹³æ»‘MPCæ§åˆ¶ç³»ç»Ÿ...");
        
        // å…¨å±€å˜é‡
        let scene, camera, renderer;
        let robot, base, arm, endEffector;
        let clock = new THREE.Clock();
        
        // å¹³æ»‘æ§åˆ¶å‚æ•°
        let motionController = {
            // ç‰©ç†å‚æ•°
            maxSpeed: 2.0,          // æœ€å¤§é€Ÿåº¦ (m/s)
            maxAcceleration: 1.0,   // æœ€å¤§åŠ é€Ÿåº¦ (m/sÂ²)
            damping: 0.8,          // é˜»å°¼ç³»æ•° (0-1)
            arrivalRadius: 0.1,    // åˆ°è¾¾åŠå¾„ (m)
            
            // å½“å‰çŠ¶æ€
            targetPosition: new THREE.Vector3(0, 0, 0),
            currentVelocity: new THREE.Vector3(0, 0, 0),
            currentAcceleration: new THREE.Vector3(0, 0, 0),
            
            // è¿åŠ¨è®°å½•
            isMoving: false,
            oscillationEnabled: false,  // éœ‡è¡æ¨¡å¼å¼€å…³
            
            // å¹³æ»‘ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®
            moveTo: function(targetX, targetZ) {
                this.targetPosition.set(targetX, 0, targetZ);
                this.isMoving = true;
                logMotion(`å¼€å§‹ç§»åŠ¨åˆ° (${targetX.toFixed(1)}, ${targetZ.toFixed(1)})`);
            },
            
            // æ›´æ–°ç‰©ç†çŠ¶æ€ (åœ¨åŠ¨ç”»å¾ªç¯ä¸­è°ƒç”¨)
            update: function(deltaTime) {
                if (!this.isMoving) return;
                
                const currentPos = new THREE.Vector3(
                    robot.position.x,
                    0,
                    robot.position.z
                );
                
                // è®¡ç®—åˆ°ç›®æ ‡çš„å‘é‡
                const toTarget = new THREE.Vector3().subVectors(
                    this.targetPosition, 
                    currentPos
                );
                
                const distance = toTarget.length();
                
                // å¦‚æœå·²ç»åˆ°è¾¾ç›®æ ‡
                if (distance < this.arrivalRadius) {
                    this.isMoving = false;
                    this.currentVelocity.set(0, 0, 0);
                    this.currentAcceleration.set(0, 0, 0);
                    logMotion(`åˆ°è¾¾ç›®æ ‡ä½ç½®ï¼Œè¯¯å·®: ${distance.toFixed(3)}m`);
                    updateSmoothness(95);
                    return;
                }
                
                // è®¡ç®—æœŸæœ›é€Ÿåº¦æ–¹å‘
                toTarget.normalize();
                
                // è®¡ç®—æœŸæœ›é€Ÿåº¦ (æ ¹æ®è·ç¦»è°ƒæ•´)
                let desiredSpeed = this.maxSpeed;
                
                // è·ç¦»ç›®æ ‡è¶Šè¿‘ï¼Œé€Ÿåº¦è¶Šæ…¢ (å¹³æ»‘åœæ­¢)
                const slowDownRadius = 3.0; // å¼€å§‹å‡é€Ÿçš„è·ç¦»
                if (distance < slowDownRadius) {
                    desiredSpeed = this.maxSpeed * (distance / slowDownRadius);
                }
                
                const desiredVelocity = toTarget.multiplyScalar(desiredSpeed);
                
                // è®¡ç®—éœ€è¦çš„åŠ é€Ÿåº¦ (PDæ§åˆ¶å™¨)
                const velocityError = new THREE.Vector3().subVectors(
                    desiredVelocity, 
                    this.currentVelocity
                );
                
                // åŸºç¡€åŠ é€Ÿåº¦ (Pé¡¹)
                this.currentAcceleration.copy(velocityError).multiplyScalar(5.0);
                
                // æ·»åŠ é˜»å°¼ (Dé¡¹)
                const dampingForce = this.currentVelocity.clone()
                    .multiplyScalar(-this.damping);
                this.currentAcceleration.add(dampingForce);
                
                // é™åˆ¶æœ€å¤§åŠ é€Ÿåº¦
                const currentAccelMag = this.currentAcceleration.length();
                if (currentAccelMag > this.maxAcceleration) {
                    this.currentAcceleration.multiplyScalar(this.maxAcceleration / currentAccelMag);
                }
                
                // æ›´æ–°é€Ÿåº¦ (ç§¯åˆ†åŠ é€Ÿåº¦)
                this.currentVelocity.add(
                    this.currentAcceleration.clone().multiplyScalar(deltaTime)
                );
                
                // é™åˆ¶æœ€å¤§é€Ÿåº¦
                const currentSpeed = this.currentVelocity.length();
                if (currentSpeed > this.maxSpeed) {
                    this.currentVelocity.multiplyScalar(this.maxSpeed / currentSpeed);
                }
                
                // æ›´æ–°ä½ç½® (ç§¯åˆ†é€Ÿåº¦)
                const positionDelta = this.currentVelocity.clone()
                    .multiplyScalar(deltaTime);
                robot.position.add(positionDelta);
                
                // å¦‚æœå¯ç”¨éœ‡è¡æ¨¡å¼ï¼Œæ·»åŠ äººä¸ºéœ‡è¡
                if (this.oscillationEnabled) {
                    const oscillation = Math.sin(performance.now() * 0.01) * 0.1;
                    robot.position.x += oscillation;
                    robot.position.z += oscillation * 0.5;
                }
                
                // ä½¿æœºå™¨äººé¢å‘è¿åŠ¨æ–¹å‘
                if (this.currentVelocity.length() > 0.1) {
                    const targetRotation = Math.atan2(
                        this.currentVelocity.x,
                        this.currentVelocity.z
                    );
                    
                    // å¹³æ»‘æ—‹è½¬ (ä½¿ç”¨Slerp)
                    const rotationSpeed = 5.0;
                    base.rotation.y += (targetRotation - base.rotation.y) 
                        * rotationSpeed * deltaTime;
                }
                
                // æ ¹æ®é€Ÿåº¦è°ƒæ•´æ‰‹è‡‚å§¿æ€
                const speedRatio = currentSpeed / this.maxSpeed;
                arm.rotation.x = Math.sin(performance.now() * 0.005) 
                    * 0.2 * speedRatio;
                
                // æ›´æ–°UIæ˜¾ç¤º
                updateMotionUI(distance, currentSpeed);
                
                // è®¡ç®—å¹³æ»‘åº¦ (åŸºäºåŠ é€Ÿåº¦å˜åŒ–)
                const smoothness = Math.max(0, 100 - currentAccelMag * 20);
                updateSmoothness(smoothness);
            },
            
            // æ€¥åœ
            stop: function() {
                this.isMoving = false;
                this.currentVelocity.set(0, 0, 0);
                this.currentAcceleration.set(0, 0, 0);
                logMotion("è¿åŠ¨åœæ­¢");
            },
            
            // è®¾ç½®æ§åˆ¶å‚æ•°
            setParameters: function(params) {
                if (params.maxSpeed) this.maxSpeed = params.maxSpeed;
                if (params.maxAcceleration) this.maxAcceleration = params.maxAcceleration;
                if (params.damping) this.damping = params.damping;
                
                updatePhysicsUI();
            }
        };
        
        // åˆå§‹åŒ–
        function init() {
            console.log("åˆå§‹åŒ–å¹³æ»‘æ§åˆ¶ç³»ç»Ÿ...");
            
            // åˆ›å»ºåœºæ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0f3460);
            
            // ç›¸æœº
            const container = document.getElementById('scene-container');
            camera = new THREE.PerspectiveCamera(
                60,
                container.clientWidth / container.clientHeight,
                0.1,
                1000
            );
            camera.position.set(15, 12, 18);
            camera.lookAt(0, 2, 0);
            
            // æ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            
            // ç¯å…‰
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(10, 20, 10);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            
            // åˆ›å»ºç¯å¢ƒ
            createEnvironment();
            
            // åˆ›å»ºæœºå™¨äºº
            createRobot();
            
            // è®¾ç½®é¼ æ ‡æ§åˆ¶
            setupMouseControls();
            
            // å¼€å§‹åŠ¨ç”»å¾ªç¯
            animate();
            
            logMotion("å¹³æ»‘æ§åˆ¶ç³»ç»Ÿå°±ç»ª");
            updatePhysicsUI();
        }
        
        function createEnvironment() {
            // åœ°é¢
            const ground = new THREE.Mesh(
                new THREE.PlaneGeometry(40, 40),
                new THREE.MeshPhongMaterial({ color: 0x1a3a5f })
            );
            ground.rotation.x = -Math.PI / 2;
            scene.add(ground);
            
            // ç½‘æ ¼
            const grid = new THREE.GridHelper(40, 40, 0x2a4d7a, 0x1a3a5f);
            grid.position.y = 0.01;
            scene.add(grid);
            
            // è·¯å¾„æ ‡è®°ç‚¹
            createPathMarkers();
        }
        
        function createRobot() {
            robot = new THREE.Group();
            
            // åº•åº§
            const baseGeometry = new THREE.CylinderGeometry(1.0, 1.2, 0.8, 16);
            const baseMaterial = new THREE.MeshPhongMaterial({ color: 0x4a5568 });
            base = new THREE.Mesh(baseGeometry, baseMaterial);
            base.position.y = 0.4;
            robot.add(base);
            
            // æœºæ¢°è‡‚
            const armGeometry = new THREE.CylinderGeometry(0.25, 0.2, 3, 8);
            const armMaterial = new THREE.MeshPhongMaterial({ color: 0x2d3748 });
            arm = new THREE.Mesh(armGeometry, armMaterial);
            arm.position.y = 2.0;
            base.add(arm);
            
            // æœ«ç«¯æ‰§è¡Œå™¨
            const endGeometry = new THREE.SphereGeometry(0.3, 16, 16);
            const endMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x00b4d8,
                emissive: 0x003049
            });
            endEffector = new THREE.Mesh(endGeometry, endMaterial);
            endEffector.position.y = 1.8;
            arm.add(endEffector);
            
            // æ·»åŠ è¿åŠ¨è½¨è¿¹çº¿
            const lineMaterial = new THREE.LineBasicMaterial({ 
                color: 0x00b4d8,
                transparent: true,
                opacity: 0.5
            });
            const lineGeometry = new THREE.BufferGeometry();
            const line = new THREE.Line(lineGeometry, lineMaterial);
            robot.add(line);
            
            scene.add(robot);
        }
        
        function createPathMarkers() {
            // åˆ›å»ºå¹³æ»‘è·¯å¾„çš„æ ‡è®°ç‚¹
            const markerPositions = [
                { x: -8, z: -8, color: 0x2a9d8f },
                { x: -4, z: -4, color: 0xf4a261 },
                { x: 0, z: 0, color: 0xe63946 },
                { x: 4, z: 4, color: 0xf4a261 },
                { x: 8, z: 8, color: 0x2a9d8f }
            ];
            
            markerPositions.forEach((pos, index) => {
                const geometry = new THREE.SphereGeometry(0.3, 16, 16);
                const material = new THREE.MeshPhongMaterial({ 
                    color: pos.color,
                    emissive: pos.color,
                    emissiveIntensity: 0.3
                });
                const marker = new THREE.Mesh(geometry, material);
                marker.position.set(pos.x, 0.3, pos.z);
                scene.add(marker);
                
                // æ·»åŠ æ ‡ç­¾
                const text = document.createElement('div');
                text.style.cssText = `
                    position: absolute;
                    color: white;
                    background: rgba(0,0,0,0.5);
                    padding: 2px 6px;
                    border-radius: 3px;
                    font-size: 12px;
                    pointer-events: none;
                `;
                text.textContent = `ç‚¹${index + 1}`;
                document.getElementById('scene-container').appendChild(text);
            });
        }
        
        // ==================== å¹³æ»‘æ¼”ç¤ºå‡½æ•° ====================
        
        async function runSmoothDemo(type) {
            logMotion(`å¼€å§‹${type}å¹³æ»‘æ¼”ç¤º`);
            
            // é‡ç½®æœºå™¨äººä½ç½®
            robot.position.set(-8, 0, -8);
            motionController.stop();
            
            switch(type) {
                case 'straight':
                    await smoothStraightPath();
                    break;
                case 'curve':
                    await smoothCurvedPath();
                    break;
                case 'pickup':
                    await smoothPickupDemo();
                    break;
            }
            
            logMotion(`${type}æ¼”ç¤ºå®Œæˆ`);
        }
        
        async function smoothStraightPath() {
            // ç›´çº¿å¹³æ»‘è·¯å¾„
            const pathPoints = [
                { x: -8, z: -8 },
                { x: -4, z: -4 },
                { x: 0, z: 0 },
                { x: 4, z: 4 },
                { x: 8, z: 8 }
            ];
            
            for (const point of pathPoints) {
                motionController.moveTo(point.x, point.z);
                
                // ç­‰å¾…åˆ°è¾¾ç›®æ ‡
                await waitUntilArrived();
                await delay(500); // çŸ­æš‚åœç•™
            }
        }
        
        async function smoothCurvedPath() {
            // è´å¡å°”æ›²çº¿è·¯å¾„ (æ›´å¤æ‚çš„è¿åŠ¨)
            const steps = 20;
            
            for (let i = 0; i <= steps; i++) {
                const t = i / steps;
                
                // äºŒæ¬¡è´å¡å°”æ›²çº¿
                const p0 = { x: -8, z: -8 };
                const p1 = { x: 0, z: -4 };   // æ§åˆ¶ç‚¹
                const p2 = { x: 8, z: 8 };
                
                const x = Math.pow(1-t, 2)*p0.x + 2*(1-t)*t*p1.x + Math.pow(t, 2)*p2.x;
                const z = Math.pow(1-t, 2)*p0.z + 2*(1-t)*t*p1.z + Math.pow(t, 2)*p2.z;
                
                motionController.moveTo(x, z);
                
                // æ›´å¯†é›†çš„æ§åˆ¶ç‚¹ï¼Œå½¢æˆå¹³æ»‘æ›²çº¿
                await delay(300);
            }
        }
        
        async function smoothPickupDemo() {
            logMotion("å¼€å§‹å¹³æ»‘æŠ“å–æ¼”ç¤º");
            
            // 1. ç§»åŠ¨åˆ°ç‰©æ–™ä½ç½®
            const materialPos = { x: 6, z: 6 };
            motionController.moveTo(materialPos.x, materialPos.z);
            await waitUntilArrived();
            
            logMotion("åˆ°è¾¾ç‰©æ–™ä½ç½®ï¼Œæ¨¡æ‹ŸæŠ“å–");
            await delay(1000);
            
            // 2. æ¬è¿åˆ°å¹³å°
            const platformPos = { x: -6, z: -6 };
            
            // å…ˆè°ƒæ•´æ§åˆ¶å‚æ•°ä¸º"ç²¾ç»†æ¨¡å¼"
            motionController.setParameters({
                maxSpeed: 1.0,
                maxAcceleration: 0.5,
                damping: 0.9
            });
            
            motionController.moveTo(platformPos.x, platformPos.z);
            await waitUntilArrived();
            
            logMotion("åˆ°è¾¾å¹³å°ä½ç½®ï¼Œæ¨¡æ‹Ÿæ”¾ç½®");
            await delay(1000);
            
            // 3. è¿”å›èµ·ç‚¹
            motionController.setParameters({
                maxSpeed: 2.0,
                maxAcceleration: 1.0,
                damping: 0.8
            });
            
            motionController.moveTo(-8, -8);
            await waitUntilArrived();
            
            logMotion("å¹³æ»‘æŠ“å–æ¼”ç¤ºå®Œæˆ");
        }
        
        function toggleOscillation() {
            motionController.oscillationEnabled = !motionController.oscillationEnabled;
            
            const button = document.getElementById('oscillationToggle');
            if (motionController.oscillationEnabled) {
                button.innerHTML = "ğŸŸ¢ å¼€å¯éœ‡è¡";
                button.parentElement.style.background = '#e63946';
                logMotion("âš ï¸ éœ‡è¡æ¨¡å¼å·²å¼€å¯ - æ¨¡æ‹Ÿæ§åˆ¶ä¸å½“çš„æƒ…å†µ");
            } else {
                button.innerHTML = "ğŸ”´ å…³é—­éœ‡è¡";
                button.parentElement.style.background = '#0077b6';
                logMotion("âœ… éœ‡è¡æ¨¡å¼å·²å…³é—­ - å¹³æ»‘æ§åˆ¶");
            }
        }
        
        // ==================== å·¥å…·å‡½æ•° ====================
        
        function waitUntilArrived() {
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    if (!motionController.isMoving) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
            });
        }
        
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function logMotion(message) {
            const logContainer = document.getElementById('motionLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(`Motion: ${message}`);
        }
        
        function updateMotionUI(distance, speed) {
            document.getElementById('positionError').textContent = 
                `${distance.toFixed(3)} m`;
            
            // æ›´æ–°å¹³æ»‘åº¦æ˜¾ç¤º
            const smoothness = Math.max(0, 100 - Math.abs(speed - 1) * 20);
            updateSmoothness(smoothness);
        }
        
        function updateSmoothness(value) {
            const clampedValue = Math.max(0, Math.min(100, value));
            document.getElementById('smoothnessValue').textContent = 
                `${Math.round(clampedValue)}%`;
            document.getElementById('smoothnessFill').style.width = 
                `${clampedValue}%`;
            
            // æ ¹æ®å¹³æ»‘åº¦æ”¹å˜é¢œè‰²
            const fill = document.getElementById('smoothnessFill');
            if (clampedValue > 80) {
                fill.style.background = 'linear-gradient(90deg, #2a9d8f, #4cc9f0)';
            } else if (clampedValue > 60) {
                fill.style.background = 'linear-gradient(90deg, #f4a261, #f9c74f)';
            } else {
                fill.style.background = 'linear-gradient(90deg, #e63946, #f4a261)';
            }
        }
        
        function updatePhysicsUI() {
            document.getElementById('maxSpeed').textContent = 
                `${motionController.maxSpeed.toFixed(1)} m/s`;
            document.getElementById('maxAccel').textContent = 
                `${motionController.maxAcceleration.toFixed(1)} m/sÂ²`;
            document.getElementById('damping').textContent = 
                motionController.damping.toFixed(2);
        }
        
        function setupMouseControls() {
            const canvas = renderer.domElement;
            let isDragging = false;
            let lastX = 0, lastY = 0;
            
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                lastX = e.clientX;
                lastY = e.clientY;
                canvas.style.cursor = 'grabbing';
            });
            
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
                canvas.style.cursor = 'grab';
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - lastX;
                const deltaY = e.clientY - lastY;
                
                const theta = deltaX * 0.01;
                const phi = deltaY * 0.01;
                
                const spherical = new THREE.Spherical();
                spherical.setFromVector3(camera.position);
                
                spherical.theta -= theta;
                spherical.phi = THREE.MathUtils.clamp(spherical.phi - phi, 0.1, Math.PI - 0.1);
                
                camera.position.setFromSpherical(spherical);
                camera.lookAt(0, 2, 0);
                
                lastX = e.clientX;
                lastY = e.clientY;
            });
            
            canvas.style.cursor = 'grab';
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            const deltaTime = Math.min(clock.getDelta(), 0.033); // é™åˆ¶æœ€å¤§deltaTime
            
            // æ›´æ–°ç‰©ç†æ§åˆ¶å™¨
            motionController.update(deltaTime);
            
            renderer.render(scene, camera);
        }
        
        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>