<!DOCTYPE html>
<html lang="en" style="height: 100%">
<head>
  <meta charset="utf-8">
</head>
<body style="height: 100%; margin: 0">
  <div id="container" style="height: 100%"></div>

  <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.6.0/dist/echarts.js"></script>

  <script type="text/javascript">
    var dom = document.getElementById('container');
    var myChart = echarts.init(dom);
    var option;

    myChart.showLoading();
    $.get('life-expectancy.json', function (data) {
      myChart.hideLoading();
      
      // 数据完整性检查
      if (!data || !data.timeline || !data.series) {
        console.error('数据结构不完整');
        alert('数据结构不完整，无法绘制图表');
        return;
      }

      // 气泡样式
      var itemStyle = {
        opacity: 0.9,
        borderColor: '#fff',
        borderWidth: 1.5
      };

      // 气泡大小计算（带非负校验和大小限制）
      var sizeFunction = function (x) {
        x = Math.max(x, 0);
        return Math.min(Math.max(x*2, 20), 200);
      };

      // 数据字段映射
      var schema = [
        { name: 'UsageFreq', text: '使用频率' },
        { name: 'GrowthRate', text: '增长比' },
        { name: 'Total', text: '总数' },
        { name: 'Field', text: '领域' }
      ];

      option = {
        baseOption: {
          timeline: {
            axisType: 'category',
        orient: 'vertical',
        autoPlay: true,
        inverse: true,
        playInterval: 1000,
        left: null,
        right: 0,
        top: 20,
        bottom: 20,
        width: 55,
        height: null,
        symbol: 'none',
        checkpointStyle: {
          borderWidth: 2
        },
        controlStyle: {
          showNextBtn: false,
          showPrevBtn: false
        },
        data: ['1983', '1984','1985', '1986', '1987', '1988', '1989', '1990', '1991', '1992', '1993', '1994', '1995', '1996', '1997', '1998', '1999', '2005', '2006', '2007', '2008', '2009', '2010', '2011', '2012', '2013', '2014', '2015', '2016', '2017', '2018', '2019', '2020', '2021', '2022', '2023', '2024']
            }
          
          ,

          title: {
            text: 'NLP各领域多色气泡图（连续型映射）',
            left: 'center',
            top: 10
          },
          tooltip: {
            formatter: function (obj) {
              var val = obj.value;
              return `${schema[3].text}：${val[3]}<br>
                      ${schema[0].text}：${val[0].toFixed(4)}<br>
                      ${schema[1].text}：${val[1].toFixed(2)}<br>
                      ${schema[2].text}：${val[2]}`;
            }
          },
          grid: { top: 80, left: 60, right: 150, bottom: 120 },
          xAxis: { type: 'value', name: '使用频率' },
          yAxis: { type: 'value', name: '增长比' },
          
          // 连续型视觉映射：按“总数（Total）”数值渐变
          visualMap: [
        {
          show: false,
          dimension: 3,
          categories: data.counties,
          inRange: {
            color: (function () {
              // prettier-ignore
              var colors = ['#51689b', '#ce5c5c', '#fbc357', '#8fbf8f', '#659d84', 
        '#fb8e6a', '#c77288', '#786090', '#91c4c5', '#6890ba',
        '#4a90e2', '#50e3c2', '#e35050', '#f7a76c', '#9b7b6b',
        '#b39ddb', '#81d4fa', '#a5d6a7', '#ffe082', '#ffab91',
        '#ce93d8', '#b0bec5', '#80deea', '#ffcc80'];
              return colors.concat(colors);
            })()
          }
        }
      ],
          
          series: [
            {
              type: 'scatter',
              itemStyle: itemStyle,
              symbolSize: function (val) { return sizeFunction(val[2]); },
              data: data.series[0] || []
            }
          ]
        },
        options: data.timeline.map((year, idx) => ({
          series: [{ data: data.series[idx] || [] }]
        }))
      };

      myChart.setOption(option);
    }).fail(function(err) {
      myChart.hideLoading();
      console.error('数据加载失败：', err);
      alert('数据加载失败，请检查JSON文件路径！');
    });

    window.addEventListener('resize', myChart.resize);
  </script>
</body>
</html>